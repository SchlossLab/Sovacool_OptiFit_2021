---
title: "vsearch clustering"
date: "Oct. 2020"
output: 
  github_document:
    html_preview: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      fig.path = "figures/"
                      )
```
```{r lib}
library(cowplot)
library(ggtext)
library(glue)
library(here)
library(knitr)
library(tidyverse)
theme_set(theme_classic())
color_palette <- RColorBrewer::brewer.pal(4, "Dark2")
dataset_colors <- c(
  human = color_palette[[3]],
  marine = color_palette[[1]],
  mouse = color_palette[[4]],
  soil = color_palette[[2]]
)
set.seed(2018)

optifit <- c('subworkflows/2_fit_reference_db/results/sensspec.tsv',
             'subworkflows/2_fit_reference_db/results/benchmarks.tsv',
             'subworkflows/2_fit_reference_db/results/fraction_reads_mapped.tsv'
             ) %>% 
  here() %>% 
  map(read_tsv) %>%
  reduce(full_join) 
opticlust <- c('subworkflows/1_prep_samples/results/sensspec.tsv',
               'subworkflows/1_prep_samples/results/benchmarks.tsv') %>% 
  here() %>% 
  map(read_tsv) %>% 
  reduce(full_join) 
vsearch <- read_tsv(here('subworkflows/4_vsearch/results/vsearch_results.tsv'))

dat <- bind_rows(optifit, opticlust) %>% 
  mutate(tool = "mothur") %>% 
  bind_rows(vsearch) %>% 
  mutate(mem_mb = max_rss,
         mem_gb = mem_mb / 1024,
         sec = s) %>% 
  filter(ref %in% c('gg', NA))
```

Preliminary results with just the soil dataset vs greengenes below.
Will expand to include more datasets later.
```{r vsearch-soil-only}
dat_filt <- dat %>% filter(ref %in% c('gg', NA), 
                           region %in% c('bact_v4', NA),
                           dataset == 'soil') %>% 
  select(dataset, ref, region, tool, method, mcc, sec, mem_gb, numotus, fraction_mapped) %>% 
  mutate(tool_method = glue("{tool}_{method}"))


dat_filt %>% pivot_longer(c(mcc, sec, mem_gb), names_to = 'metric') %>% 
  ggplot(aes(x = method, y = value, color = tool)) +
  geom_boxplot() +
  facet_wrap('metric', scales = 'free') + 
  labs(caption = "For reference clustering, the soil dataset was fit to the greengenes db.") +
  theme(axis.title = element_blank())
```

After updating vsearch calls with parameters from Pat's scripts,
vsearch performance improves slightly:
```{r vsearch_mcc_new-params}
vsearch %>% 
  select(dataset, method, mcc) %>% 
  ggplot(aes(method, mcc, color = dataset)) + 
  geom_point() +
  ylim(0,1) + 
  scale_color_manual(values = dataset_colors)
```


## OTU Quality

```{r vsearch_mcc}
mcc <- dat %>% ggplot(aes(x = method, y = mcc, color = tool)) +
  geom_boxplot() +
  facet_wrap('dataset', ncol = 1) +
  ylim(0, 1) + 
  labs(x = '')
mcc
```

## Performance

```{r vsearch_runtime}
sec <- dat %>% ggplot(aes(x = method, y = sec, color = tool)) +
  geom_boxplot() +
  facet_wrap('dataset', scales = 'free', ncol = 1)  +
  labs(x = '')
sec
mem <- dat %>% ggplot(aes(x = method, y = mem_gb, color = tool)) +
  geom_boxplot() +
  facet_wrap('dataset', scales = 'free', ncol = 1)  +
  labs(x = '')
mem
```


## Fraction reads mapped during closed-reference clustering

```{r vsearch_fraction}
dat %>% filter(method == 'closed') %>% 
  ggplot(aes(x = method, y = fraction_mapped, color = tool)) +
  geom_boxplot() +
  facet_wrap('dataset') +
  ylim(0, 1) +
  labs(caption = 'Sequences were aligned to the greengenes database.')
```


## All metrics summarized on one plot

```{r vsearch_summary}
dat %>% pivot_longer(c(mcc, sec, mem_gb), names_to = 'metric') %>% 
  ggplot(aes(x = method, y = value, color = tool)) +
  geom_boxplot() +
  facet_wrap(dataset ~ metric, scales = 'free', ncol = 3, nrow = 4) + 
  labs(caption = "For reference clustering, the soil dataset was fit to the greengenes db.") +
  theme(axis.title = element_blank())
```

```{r vsearch_cowplot}
legend <- get_legend(mcc)
pgrid <- plot_grid(mcc + theme(legend.position = 'none'), 
          sec + theme(legend.position = 'none'), 
          mem + theme(legend.position = 'none'), 
          align = 'h', nrow = 1)
plot_grid(pgrid, legend, rel_widths = c(3, .4))
```

TODO: compare diversity metrics
