configfile: '../../config/config.yaml'

datasets = config['datasets']
refs = config['references']
methods = config['methods']

regions = ['bact_v4']
perc_identity = 0.97  # to match mothur's 0.3 dissimilarity threshold

wildcard_constraints:
    region='bact_v4'

subworkflow prep_samples:
    workdir:
        "../1_prep_samples/"
subworkflow fit_ref_db:
    workdir:
        "../2_fit_reference_db/"

rule targets_vsearch:
    input:
        expand('results/{dataset}/de_novo/{dataset}{ext}',
            dataset = datasets,
            ext = ['_clusters.tsv', '.shared']
        )

rule prep_count_table_mothur:
    input:
        count=prep_samples("data/{dataset}/processed/{dataset}.count_table"),
        code="../../code/R/mutate_ref_count.R"
    output:
        count='data/{dataset}/{dataset}.count_table'
    script:
        "../../code/R/mutate_ref_count.R"

rule vsearch_de_novo:
    input:
        fasta=prep_samples("data/{dataset}/processed/{dataset}.fasta")
    output:
        shared='results/{dataset}/de_novo/{dataset}.shared',
        tsv='results/{dataset}/de_novo/{dataset}_clusters.tsv'
    params:
        perc_identity=perc_identity
    resources:
        procs=8
    shell:
        """
        vsearch --cluster_size {input.fasta} \
            --uc {output.tsv} \
            --mothur_shared_out {output.shared} \
            --threads {resources.procs} \
            --id {params.perc_identity} \
            --relabel OTU_ \
            --relabel_keep \
            --qmask none \
            --xsize \
            --minseqlength 1 \
            --fasta_width 0 \
        """

rule vsearch_closed_ref:
    input:
        query=prep_samples("data/{dataset}/processed/{dataset}.fasta"),
        ref=fit_ref_db("data/{dataset}_{ref}_{region}/preclust_db/{ref}.{region}.filter.unique.precluster.fasta")

rule vsearch_open_ref:
    input:
        query=prep_samples("data/{dataset}/processed/{dataset}.fasta"),
        ref=fit_ref_db("data/{dataset}_{ref}_{region}/preclust_db/{ref}.{region}.filter.unique.precluster.fasta")

rule make_list:
    input:
        tsv='{input_dir}/{dataset}_clusters.tsv'
    output:
        list='{input_dir}/{dataset}_clusters.list'

# TODO: mothur sens.spec on vsearch output for performance metrics
rule sensspec:
    input:
        list=rules.make_list.output.list,
        count=rules.prep_count_table_mothur.output.count,
        dist=prep_samples("results/{dataset}/{dataset}.dist")
    output:
        tsv='{input_dir}/{dataset}.sensspec'
    shell:
        """
        mothur '#set.dir(output={params.outdir});
            sens.spec(list={input.list}, count={input.count}, column={input.dist}) '
        """

# TODO: aggregate benchmarks
